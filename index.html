<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Hey!Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="h-screen flex items-center justify-center bg-gradient-to-br from-sky-200 to-blue-100 text-black">

  <!-- ユーザー名入力画面 -->
  <div id="username-screen" class="w-full max-w-md p-6 bg-white/60 backdrop-blur-md rounded-2xl shadow-lg">
    <h1 class="text-2xl font-bold mb-4 text-center">Hey!Chat</h1>
    <p class="text-center mb-4">名前を入力してください</p>
    <input id="username-input" type="text" maxlength="20"
      class="w-full p-2 border rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-blue-400"
      placeholder="ユーザー名を入力..." />
    <button id="next-btn"
      class="w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 transition">
      次へ
    </button>
  </div>

  <!-- 部屋選択画面 -->
  <div id="room-screen" class="hidden w-full max-w-md p-6 bg-white/60 backdrop-blur-md rounded-2xl shadow-lg text-center">
    <h2 class="text-xl mb-4 font-semibold">どこに行きますか？</h2>
    <button id="world-btn" class="w-full mb-3 bg-green-500 text-white py-2 rounded-lg hover:bg-green-600 transition">全世界</button>
    <button id="invite-btn" class="w-full bg-purple-500 text-white py-2 rounded-lg hover:bg-purple-600 transition">招待</button>
  </div>

  <!-- チャット画面 -->
  <div id="chat-screen" class="hidden flex flex-col w-full max-w-2xl h-[90vh] bg-white/70 backdrop-blur-md rounded-2xl shadow-xl overflow-hidden">
    <!-- ヘッダー -->
    <div class="flex items-center justify-between p-4 border-b">
      <div>
        <h1 class="text-lg font-bold">RetroChat</h1>
        <p id="user-label" class="text-sm text-gray-600"></p>
      </div>
      <button id="exit-btn" class="text-sm text-gray-700 border px-3 py-1 rounded-lg hover:bg-gray-100">退出</button>
    </div>

    <!-- メッセージ表示エリア -->
    <div id="messages" class="flex-1 p-4 overflow-y-auto space-y-3"></div>

    <!-- 入力エリア -->
    <div class="flex p-4 border-t gap-2">
      <input id="message-input" type="text" placeholder="メッセージを入力..."
        class="flex-1 p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400"/>
      <button id="send-btn" class="bg-blue-500 text-white px-4 rounded-lg hover:bg-blue-600 transition">送信</button>
    </div>
  </div>

  <!-- 効果音 -->
  <audio id="next-sound" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg"></audio>

  <script>
    const FIREBASE_URL = "https://hack-script-e899a-default-rtdb.firebaseio.com";

    let username = "";
    let room = null;

    const usernameScreen = document.getElementById("username-screen");
    const roomScreen = document.getElementById("room-screen");
    const chatScreen = document.getElementById("chat-screen");

    const nextBtn = document.getElementById("next-btn");
    const usernameInput = document.getElementById("username-input");
    const userLabel = document.getElementById("user-label");
    const worldBtn = document.getElementById("world-btn");
    const inviteBtn = document.getElementById("invite-btn");
    const exitBtn = document.getElementById("exit-btn");

    const messagesDiv = document.getElementById("messages");
    const messageInput = document.getElementById("message-input");
    const sendBtn = document.getElementById("send-btn");
    const nextSound = document.getElementById("next-sound");

    // ユーザー名設定
    nextBtn.onclick = () => {
      if (usernameInput.value.trim()) {
        username = usernameInput.value.trim();
        userLabel.textContent = username + " として参加中";
        usernameScreen.classList.add("hidden");
        roomScreen.classList.remove("hidden");
        nextSound.play();
      }
    };

    // 部屋選択
    worldBtn.onclick = () => {
      room = "world";
      roomScreen.classList.add("hidden");
      chatScreen.classList.remove("hidden");
      fetchMessages();
      setInterval(fetchMessages, 2000);
    };

    inviteBtn.onclick = () => {
      const code = prompt("招待コードを入力");
      if (code) {
        room = code;
        roomScreen.classList.add("hidden");
        chatScreen.classList.remove("hidden");
        fetchMessages();
        setInterval(fetchMessages, 2000);
      }
    };

    exitBtn.onclick = () => {
      chatScreen.classList.add("hidden");
      roomScreen.classList.remove("hidden");
      room = null;
    };

    // メッセージ送信
    sendBtn.onclick = sendMessage;
    messageInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    function sendMessage() {
      const text = messageInput.value.trim();
      if (!text || !room) return;

      const message = {
        text,
        username,
        timestamp: Date.now(),
      };

      fetch(`${FIREBASE_URL}/rooms/${room}/chat.json`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(message),
      }).then(() => {
        messageInput.value = "";
        fetchMessages();
      });
    }

    function fetchMessages() {
      if (!room) return;
      fetch(`${FIREBASE_URL}/rooms/${room}/chat.json`)
        .then(res => res.json())
        .then(data => {
          messagesDiv.innerHTML = "";
          if (data) {
            const msgs = Object.entries(data).map(([id, msg]) => msg);
            msgs.sort((a, b) => a.timestamp - b.timestamp);
            msgs.forEach(msg => {
              const div = document.createElement("div");
              div.className = "p-2 bg-white/70 rounded-lg shadow-sm";
              div.innerHTML = `<strong>${msg.username}</strong>: ${msg.text}`;
              messagesDiv.appendChild(div);
            });
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
          }
        });
    }
  </script>
</body>
</html>
